"use strict";(self.webpackChunkandroid_utils_docs=self.webpackChunkandroid_utils_docs||[]).push([[669],{3905:(e,t,a)=>{a.d(t,{Zo:()=>m,kt:()=>h});var n=a(7294);function i(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function r(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function o(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?r(Object(a),!0).forEach((function(t){i(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):r(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function l(e,t){if(null==e)return{};var a,n,i=function(e,t){if(null==e)return{};var a,n,i={},r=Object.keys(e);for(n=0;n<r.length;n++)a=r[n],t.indexOf(a)>=0||(i[a]=e[a]);return i}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(n=0;n<r.length;n++)a=r[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(i[a]=e[a])}return i}var s=n.createContext({}),p=function(e){var t=n.useContext(s),a=t;return e&&(a="function"==typeof e?e(t):o(o({},t),e)),a},m=function(e){var t=p(e.components);return n.createElement(s.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},d=n.forwardRef((function(e,t){var a=e.components,i=e.mdxType,r=e.originalType,s=e.parentName,m=l(e,["components","mdxType","originalType","parentName"]),d=p(a),h=i,c=d["".concat(s,".").concat(h)]||d[h]||u[h]||r;return a?n.createElement(c,o(o({ref:t},m),{},{components:a})):n.createElement(c,o({ref:t},m))}));function h(e,t){var a=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var r=a.length,o=new Array(r);o[0]=d;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l.mdxType="string"==typeof e?e:i,o[1]=l;for(var p=2;p<r;p++)o[p]=a[p];return n.createElement.apply(null,o)}return n.createElement.apply(null,a)}d.displayName="MDXCreateElement"},3138:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>s,contentTitle:()=>o,default:()=>u,frontMatter:()=>r,metadata:()=>l,toc:()=>p});var n=a(7462),i=(a(7294),a(3905));const r={id:"premium-app",title:"Premium App",description:"Set of utilities to simplify the verification and purchase process of the premium version of the app."},o=void 0,l={unversionedId:"library-utilities/premium-app",id:"library-utilities/premium-app",title:"Premium App",description:"Set of utilities to simplify the verification and purchase process of the premium version of the app.",source:"@site/docs/library-utilities/premium-app.md",sourceDirName:"library-utilities",slug:"/library-utilities/premium-app",permalink:"/Android-Utils/docs/library-utilities/premium-app",draft:!1,editUrl:"https://github.com/JeovaniMartinez/Android-Utils/edit/documentation/docs/library-utilities/premium-app.md",tags:[],version:"current",frontMatter:{id:"premium-app",title:"Premium App",description:"Set of utilities to simplify the verification and purchase process of the premium version of the app."},sidebar:"mainSidebar",previous:{title:"Translucent Theme",permalink:"/Android-Utils/docs/library-utilities/translucent-theme"},next:{title:"File Utils",permalink:"/Android-Utils/docs/library-utilities/file-utils"}},s={},p=[{value:"Description",id:"description",level:2},{value:"Use cases",id:"use-cases",level:3},{value:"Security",id:"security",level:3},{value:"Getting Ready",id:"getting-ready",level:2},{value:"1. License Testing",id:"1-license-testing",level:3},{value:"2. Setup The Project",id:"2-setup-the-project",level:3},{value:"3. Publish The App",id:"3-publish-the-app",level:3},{value:"4. Create In-app Product",id:"4-create-in-app-product",level:3},{value:"Considerations",id:"considerations",level:4},{value:"Components",id:"components",level:2},{value:"Premium.State",id:"premiumstate",level:3},{value:"Premium.Listener",id:"premiumlistener",level:3},{value:"Premium.Controller",id:"premiumcontroller",level:3},{value:"Premium.getCurrentState()",id:"premiumgetcurrentstate",level:3},{value:"Implementation",id:"implementation",level:2},{value:"General",id:"general",level:3},{value:"Verification",id:"verification",level:3},{value:"Product Details",id:"product-details",level:3},{value:"Start Purchase",id:"start-purchase",level:3},{value:"Considerations",id:"considerations-1",level:3},{value:"Testing",id:"testing",level:2},{value:"Test List",id:"test-list",level:3}],m={toc:p};function u(e){let{components:t,...a}=e;return(0,i.kt)("wrapper",(0,n.Z)({},m,a,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("h2",{id:"description"},"Description"),(0,i.kt)("p",null,"Set of utilities to simplify the verification and purchase process of the premium version of the app."),(0,i.kt)("p",null,"It provides an abstraction layer to interact with the ",(0,i.kt)("a",{parentName:"p",href:"https://developer.android.com/google/play/billing"},"Google Play Billing Library,")," simplifying\nthe process and allowing a quick and easy integration\ninto any app."),(0,i.kt)("hr",null),(0,i.kt)("h3",{id:"use-cases"},"Use cases"),(0,i.kt)("p",null,"On many occasions, when we develop an app we integrate ads or premium functions. A common practice is to create a free app on Google Ply, which\nimplements the ads and has certain restrictions, and another paid app without ads and with Premium features. This usually has some drawbacks, and the\nbest practice is to create only a free app, which shows ads and restricts certain functions, and then, through a purchase, remove these ads and\nrestrictions, which allows us to have only one app that is easier to manage and update. That is where this library utility comes into play, allowing\nsuch an implementation to be carried out easily and with few code lines."),(0,i.kt)("hr",null),(0,i.kt)("h3",{id:"security"},"Security"),(0,i.kt)("div",{className:"admonition admonition-warning alert alert--danger"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"}))),"warning")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"Before implementing this utility in your app, please read the entire documentation to determine if it is the right option for your needs."))),(0,i.kt)("p",null,"As your app grows in popularity, it can also attract the unwanted attention of malicious users that might want to abuse your app. In this case, we are\ngoing to focus on analyzing the security of the implementation of this library utility."),(0,i.kt)("p",null,"If you publish a free app with ads and limited features and, and a paid app with no ads and features unlocked, a malicious user can easily generate\nan apk of your premium app and distribute it. But if you only have one app, and the premium features are limited by an in-app purchase (how this utility\ndoes it), a malicious user must use reverse engineer in your app in order to remove the restrictions, although this may be easy for hackers, it provides\na little more complexity than the previous example."),(0,i.kt)("p",null,"Based on the above, if you only need to remove the ads from your app or unlock some features through in-app purchase, this utility may be the right\none for you. If, on the other hand, you need a more rigorous verification of the purchases in your app, you must carry out your own implementation by\nperforming the validations in your back end. You can read more information about security ",(0,i.kt)("a",{parentName:"p",href:"https://developer.android.com/google/play/billing/security"},"here.")),(0,i.kt)("hr",null),(0,i.kt)("h2",{id:"getting-ready"},"Getting Ready"),(0,i.kt)("p",null,"Before we start, we need to prepare a few things to be able to use this library utility."),(0,i.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"tip")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"Before starting, is recommend you take a look at the ",(0,i.kt)("a",{parentName:"p",href:"https://developer.android.com/google/play/billing"},"official documentation of Google Play's billing system,"),"\nso that you can understand how it works and know the terminology."))),(0,i.kt)("h3",{id:"1-license-testing"},"1. License Testing"),(0,i.kt)("p",null,"In order to test the implementation in your app, you must have at least one license for testing,\n",(0,i.kt)("a",{parentName:"p",href:"https://support.google.com/googleplay/android-developer/answer/6062777"},"here")," you will find information and the steps to create them."),(0,i.kt)("h3",{id:"2-setup-the-project"},"2. Setup The Project"),(0,i.kt)("p",null,"2.1.- Add the Google Play Billing Library implementation in Gradle file at app level."),(0,i.kt)("div",{className:"admonition admonition-caution alert alert--warning"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 16 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"}))),"caution")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"It is strongly recommended to add the indicated version ",(0,i.kt)("inlineCode",{parentName:"p"},"(3.0.3)"),", to avoid conflicts with dependencies."))),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-gradle",metastring:"{3}","{3}":!0},"dependencies {\n    ...\n    implementation 'com.android.billingclient:billing-ktx:3.0.3'\n}\n")),(0,i.kt)("p",null,"2.2.- In the ",(0,i.kt)("inlineCode",{parentName:"p"},"AndroidManifest"),", add billing permission."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-xml"},' <uses-permission android:name="com.android.vending.BILLING" />\n')),(0,i.kt)("h3",{id:"3-publish-the-app"},"3. Publish The App"),(0,i.kt)("p",null,"Once you have the project configured, you must generate an apk or bundle of it and publish it on Google Play in any track, including the internal test track.\n",(0,i.kt)("em",{parentName:"p"},"This is necessary to be able to create the products integrated in the Google Play Console, since when uploading the app with the indicated configuring,\nthe billing functions are enabled.")),(0,i.kt)("h3",{id:"4-create-in-app-product"},"4. Create In-app Product"),(0,i.kt)("p",null,"Now it is necessary to create one or more products in the Google Play console that grant premium access to the app, this can be done by following\n",(0,i.kt)("a",{parentName:"p",href:"https://support.google.com/googleplay/android-developer/answer/1153481?hl#zippy=%2Ccreate-a-single-managed-product"},"these steps.")),(0,i.kt)("h4",{id:"considerations"},"Considerations"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"The id of the created product we will call ",(0,i.kt)("inlineCode",{parentName:"li"},"sku"),", since this is how it handles it the Google Play billing library."),(0,i.kt)("li",{parentName:"ul"},"The product must have the ",(0,i.kt)("inlineCode",{parentName:"li"},"active")," state to be able to handle it in the app.")),(0,i.kt)("hr",null),(0,i.kt)("h2",{id:"components"},"Components"),(0,i.kt)("p",null,"The utility is made up of the following components:"),(0,i.kt)("h3",{id:"premiumstate"},"Premium.State"),(0,i.kt)("blockquote",null,(0,i.kt)("p",{parentName:"blockquote"},"Enum defining the possible states when checking if a user has premium privileges in the app."),(0,i.kt)("a",{href:"/reference/-android%20-utils/com.jeovanimartinez.androidutils.billing.premium/-premium/-state/index.html",target:"_blank"},(0,i.kt)("b",null,"[ Reference ]"))),(0,i.kt)("h3",{id:"premiumlistener"},"Premium.Listener"),(0,i.kt)("blockquote",null,(0,i.kt)("p",{parentName:"blockquote"},"Listener for events relating to app premium billing."),(0,i.kt)("a",{href:"/reference/-android%20-utils/com.jeovanimartinez.androidutils.billing.premium/-premium/-listener/index.html",target:"_blank"},(0,i.kt)("b",null,"[ Reference ]"))),(0,i.kt)("h3",{id:"premiumcontroller"},"Premium.Controller"),(0,i.kt)("blockquote",null,(0,i.kt)("p",{parentName:"blockquote"},"Controller for the purchase and verification process of the premium version of the app."),(0,i.kt)("a",{href:"/reference/-android%20-utils/com.jeovanimartinez.androidutils.billing.premium/-premium/-controller/index.html",target:"_blank"},(0,i.kt)("b",null,"[ Reference ]"))),(0,i.kt)("h3",{id:"premiumgetcurrentstate"},"Premium.getCurrentState()"),(0,i.kt)("blockquote",null,(0,i.kt)("p",{parentName:"blockquote"},"Function that returns the current premium state. It value must be used in all conditions within the app where it is necessary to verify the premium state."),(0,i.kt)("a",{href:"/reference/-android%20-utils/com.jeovanimartinez.androidutils.billing.premium/-premium/get-current-state.html",target:"_blank"},(0,i.kt)("b",null,"[ Reference ]"))),(0,i.kt)("hr",null),(0,i.kt)("h2",{id:"implementation"},"Implementation"),(0,i.kt)("p",null,"Since we have all the above steps covered, we can now implement the utility as shown below."),(0,i.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"tip")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"The library provides a detailed flow In the logcat, that you can consult to see a detailed flow of what is being done."))),(0,i.kt)("h3",{id:"general"},"General"),(0,i.kt)("p",null,"General implementation."),(0,i.kt)("p",null,"1.- In the ",(0,i.kt)("inlineCode",{parentName:"p"},"onCreate()")," of the singleton or main activity, the utility should be initialized."),(0,i.kt)("blockquote",null,(0,i.kt)("h4",{parentName:"blockquote",id:"-configuration-parameters-"},(0,i.kt)("a",{href:"/reference/-android%20-utils/com.jeovanimartinez.androidutils.billing.premium/-premium/-controller/init.html",target:"_blank"},(0,i.kt)("b",null,"[ Configuration Parameters ]")))),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-kotlin"},'Premium.Controller.init(context, listOf("premium_upgrade"))\n')),(0,i.kt)("p",null,"2.- Later we must set the listener in the place where we want to receive the events related to the app premium billing."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-kotlin",metastring:"{8}","{8}":!0},"val listener = object : Premium.Listener {\n    override fun onCheckPremium(state: Premium.State) {}\n    override fun onPurchaseResult(result: Premium.State) {}\n    override fun onSkuDetails(skuDetails: List<SkuDetails>?) {}\n    override fun onStartPurchaseError(code: Int) {}\n}\n\nPremium.Controller.setListener(listener)\n")),(0,i.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"tip")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"You can have several listeners in different places, just remember to set and remove them where required."),(0,i.kt)("pre",{parentName:"div"},(0,i.kt)("code",{parentName:"pre",className:"language-kotlin"},"Premium.Controller.setListener(listener) // To set the listener\n\nPremium.Controller.removeListener() // To remove the listener\n")))),(0,i.kt)("hr",null),(0,i.kt)("h3",{id:"verification"},"Verification"),(0,i.kt)("p",null,"We must verify whether the user has premium privileges at least on the following occasions."),(0,i.kt)("p",null,"1.- On launch main activity, we must do a quick check of the current state, to know if the user is premium or not, and show the appropriate\ncontent, for example:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-kotlin"},"if (Premium.getCurrentState() == Premium.State.PREMIUM) {\n    // Code to execute if the user is premium, for example, hide ads\n} else {\n    // Code to execute if the user is not premium, for example, show ads\n}\n")),(0,i.kt)("p",null,"2.- The previous verification, aims to show the appropriate content at the launch the app, now we must do a direct verification with the billing client,\nto update the premium state, this can be done as follows:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-kotlin"},"Premium.Controller.checkPremium(context)\n")),(0,i.kt)("p",null,"The verification is executed asynchronously, and the result is reported by the listener."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-kotlin"},"override fun onCheckPremium(state: Premium.State) {\n    if (state == Premium.State.PREMIUM) {\n        // Code to execute if the user is premium, for example, hide ads\n    } else {\n        // Code to execute if the user is not premium, for example, show ads\n    }\n}\n")),(0,i.kt)("hr",null),(0,i.kt)("h3",{id:"product-details"},"Product Details"),(0,i.kt)("p",null,"This process is optional, and it will help us to show details of the product that provides the premium benefits (name, description, price in the\nuser's currency, etc.)."),(0,i.kt)("p",null,"The request is performed as follows:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-kotlin"},'Premium.Controller.getSkuDetails(context, listOf("premium_upgrade"))\n')),(0,i.kt)("p",null,"And the result is reported by the listener."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-kotlin"},"override fun onSkuDetails(skuDetails: List<SkuDetails>?) {\n    if (skuDetails != null) {\n        // Show product details\n    } else {\n        // Show error message\n    }\n}\n")),(0,i.kt)("hr",null),(0,i.kt)("h3",{id:"start-purchase"},"Start Purchase"),(0,i.kt)("p",null,"The purchase of the product is performed as follows."),(0,i.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"Before starting the purchase, check the current premium state, and start the purchase only if the user is not premium. For example:"),(0,i.kt)("pre",{parentName:"div"},(0,i.kt)("code",{parentName:"pre",className:"language-kotlin"},'when (Premium.getCurrentState()) {\n    Premium.State.NOT_PREMIUM -> Premium.Controller.startPurchase(activity, "premium_upgrade")\n    Premium.State.PENDING_TRANSACTION -> longToast("The purchase is pending...")\n    Premium.State.PREMIUM -> longToast("You are already a premium user...")\n}\n')))),(0,i.kt)("p",null,"To start the purchase:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-kotlin"},'Premium.Controller.startPurchase(activity, "premium_upgrade")\n')),(0,i.kt)("p",null,"In case of an error, it is reported by the listener."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-kotlin"},'override fun onStartPurchaseError(code: Int) {\n    longToast("Service unavailable, please try again later")\n}\n')),(0,i.kt)("p",null,"If the purchase flow was shown successfully, the result (the purchase was completed, its canceled, its pending, etc.) is reported through the listener."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-kotlin"},'override fun onPurchaseResult(result: Premium.State) {\n    if (result == Premium.State.PREMIUM) {\n        // Code to execute if the user is premium, for example, hide ads\n    } else {\n        // Code to execute if the user is not premium, for example, show ads\n    }\n\n    // This is a good place to indicate to the user the result of the purchase\n    when (result) {\n        Premium.State.NOT_PREMIUM -> longToast("Purchase canceled")\n        Premium.State.PENDING_TRANSACTION -> longToast("Thanks, the purchase is pending...")\n        Premium.State.PREMIUM -> longToast("Thank you for purchasing the premium version...")\n    }\n}\n')),(0,i.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"If the purchase was made through a deferred payment, the listener function is invoked at the end of the flow, with the result ",(0,i.kt)("inlineCode",{parentName:"p"},"State.PENDING_TRANSACTION"),",\nand it is invoked again when the transaction is completed, with the new result ",(0,i.kt)("inlineCode",{parentName:"p"},"State.NOT_PREMIUM")," or ",(0,i.kt)("inlineCode",{parentName:"p"},"State.PREMIUM"),"."))),(0,i.kt)("hr",null),(0,i.kt)("h3",{id:"considerations-1"},"Considerations"),(0,i.kt)("p",null,"It is recommended to check the premium state in the ",(0,i.kt)("inlineCode",{parentName:"p"},"onResume()")," of the main activity, and if the state is ",(0,i.kt)("inlineCode",{parentName:"p"},"State.PENDING_TRANSACTION"),", check\nthe state again with the billing client, this in case the listener did not inform when the state of the pending transaction was updated."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-kotlin"},"if (Premium.getCurrentState() == Premium.State.PENDING_TRANSACTION) {\n    Premium.Controller.checkPremium(context)\n}\n")),(0,i.kt)("hr",null),(0,i.kt)("h2",{id:"testing"},"Testing"),(0,i.kt)("p",null,"It is recommended to perform out the following list of tests after implementing the utility, to verify that everything works correctly."),(0,i.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"tip")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("ul",{parentName:"div"},(0,i.kt)("li",{parentName:"ul"},"To perform multiple test purchases for the same product, you can ",(0,i.kt)("a",{parentName:"li",href:"https://support.google.com/googleplay/android-developer/answer/2741495"},"refund and revoke purchases using Google Play console.")),(0,i.kt)("li",{parentName:"ul"},"To force the state of a purchase to be updated (for example, after a refund), go to the details of the Google Play and clear the data."),(0,i.kt)("li",{parentName:"ul"},"To simulate the billing client disconnection, go to the details of the Google Play and force app stop.")))),(0,i.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("ul",{parentName:"div"},(0,i.kt)("li",{parentName:"ul"},"In some tests carried out, when using ",(0,i.kt)("strong",{parentName:"li"},(0,i.kt)("em",{parentName:"strong"},"[ Slow test card, approves after a few minutes ]")),", the rejection confirmation was not received, so in\nthis case, after about 5 minutes of having carried out the test, it is necessary to clear the data from the google play app for it to be updated the state."),(0,i.kt)("li",{parentName:"ul"},"When using any ",(0,i.kt)("strong",{parentName:"li"},(0,i.kt)("em",{parentName:"strong"},"[ Approves card ]")),", when test the purchase, the purchase must be acknowledge, the utility does the process automatically, but the app must be open or it must be opened after about 2 minutes of making the purchase. If this is not done, the purchase is likely to go to refunded status.")))),(0,i.kt)("h3",{id:"test-list"},"Test List"),(0,i.kt)("table",null,(0,i.kt)("thead",{parentName:"table"},(0,i.kt)("tr",{parentName:"thead"},(0,i.kt)("th",{parentName:"tr",align:null}),(0,i.kt)("th",{parentName:"tr",align:null},"Description"))),(0,i.kt)("tbody",{parentName:"table"},(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"1"),(0,i.kt)("td",{parentName:"tr",align:null},"Try on a device that does not have Google Play (such as an emulator), the purchase flow should not start and a message or dialog should be displayed  to indicate to the user that the service is not available.")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"2"),(0,i.kt)("td",{parentName:"tr",align:null},"Start the purchase flow and complete with ",(0,i.kt)("strong",{parentName:"td"},(0,i.kt)("em",{parentName:"strong"},"[ Test card, always declines ]")),", a message must be displayed in the flow, and when returning to the app nothing should happen, the user must not be premium. ",(0,i.kt)("br",null)," The status of the order in the Google Play console of  must be ",(0,i.kt)("em",{parentName:"td"},"Payment declined"),".")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"3"),(0,i.kt)("td",{parentName:"tr",align:null},"Start the purchase flow, and complete with ",(0,i.kt)("strong",{parentName:"td"},(0,i.kt)("em",{parentName:"strong"},"[ Slow test card, declines after a few minutes ]")),", the purchase flow is finalized and you can show a message to indicate the purchase state. Premium rights should not be granted yet, if the user wants to buy the premium version, they must be told that the payment confirmation is waiting. During the wait, do not close the app, and wait for the rejection confirmation to be received, so the buy button is re-enabled. The rejection confirmation will be received in approximately 1-2 minutes. ",(0,i.kt)("br",null)," The status in the Google Play console of the order must go through ",(0,i.kt)("em",{parentName:"td"},"Payment pending")," > ",(0,i.kt)("em",{parentName:"td"},"Payment declined"),".")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"4"),(0,i.kt)("td",{parentName:"tr",align:null},"Start the purchase flow, and complete with ",(0,i.kt)("strong",{parentName:"td"},(0,i.kt)("em",{parentName:"strong"},"[ Slow test card, declines after a few minutes ]")),", the purchase flow is finalized and you can show a message to indicate the purchase state. Premium rights should not be granted yet, later, close the app, wait about 2-3 minutes and open the app again, as the purchase was rejected, the option to buy again should appear and the user should not be premium. ",(0,i.kt)("br",null)," The status in the Google Play console of the order must go through ",(0,i.kt)("em",{parentName:"td"},"Payment pending")," > ",(0,i.kt)("em",{parentName:"td"},"Payment declined"),".")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"5"),(0,i.kt)("td",{parentName:"tr",align:null},"Start the purchase flow and complete with ",(0,i.kt)("strong",{parentName:"td"},(0,i.kt)("em",{parentName:"strong"},"[ Test card, always approves ]")),", at the end of the purchase flow, a thanks message should be displayed, and from that moment the user is premium. Wait a moment and close the app and wait about 8 minutes, open the app again and the user must remain premium. ",(0,i.kt)("br",null)," The status in the Google Play console of the order must go through ",(0,i.kt)("em",{parentName:"td"},"Chargeable")," > ",(0,i.kt)("em",{parentName:"td"},"Charged"),".")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"6"),(0,i.kt)("td",{parentName:"tr",align:null},"Start the purchase flow and complete with ",(0,i.kt)("strong",{parentName:"td"},(0,i.kt)("em",{parentName:"strong"},"[ Slow test card, approves after a few minutes ]")),", the purchase flow is finished and you can show a message to indicate the purchase state. Premium rights should not be granted yet, if the user wants to buy the premium version again, they must be told that the payment confirmation is waiting. During the wait, do not close the app, and wait for the approval confirmation to be received, at that moment a thanks message is displayed, and the premium functions are enabled (The approval confirmation will be received in approximately 1-2 minutes.). After, close the app and wait about 8 minutes, open the app again and the user must remain premium. ",(0,i.kt)("br",null)," The status in the Google Play console of the order must go through ",(0,i.kt)("em",{parentName:"td"},"Payment pending")," > ",(0,i.kt)("em",{parentName:"td"},"Chargeable")," > ",(0,i.kt)("em",{parentName:"td"},"Charged"),".")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"7"),(0,i.kt)("td",{parentName:"tr",align:null},"Start the purchase flow and complete with ",(0,i.kt)("strong",{parentName:"td"},(0,i.kt)("em",{parentName:"strong"},"[ Slow test card, approves after a few minutes ]")),", the purchase flow is finished and you can show a message to indicate the purchase state. Premium rights should not be granted yet, later, close the app, wait about 2 minutes and open it the app again, and the user should already be premium. ",(0,i.kt)("br",null)," The status in the Google Play console of the order must go through ",(0,i.kt)("em",{parentName:"td"},"Payment pending")," > ",(0,i.kt)("em",{parentName:"td"},"Chargeable")," > ",(0,i.kt)("em",{parentName:"td"},"Charged"),". ",(0,i.kt)("br",null)," ",(0,i.kt)("em",{parentName:"td"},"If you do not open the app within 3 minutes after making the purchase, it will not be acknowledged and a refund will be made."))),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"8"),(0,i.kt)("td",{parentName:"tr",align:null},"If you have an older version of the app, make sure that the user is not premium, then update the app, as the user was not premium, it must remain a non-premium user.")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"9"),(0,i.kt)("td",{parentName:"tr",align:null},"If you have an older version of the app, buy the premium product in that previous version, update the app to the new version and make sure that the purchase and premium benefits are preserved.")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"10"),(0,i.kt)("td",{parentName:"tr",align:null},"If you have an older version of the app, and the integrated product offering the premium benefits (sku) has changed in the new version, make sure that users who purchased previous integrated products keep the premium benefits.")))))}u.isMDXComponent=!0}}]);